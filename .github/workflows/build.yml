name: Build Titan ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update package repositories
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y

      - name: Install build dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-utils \
            git \
            curl \
            wget \
            gnupg2 \
            ca-certificates

      - name: Install Debian keyrings
        run: |
          sudo apt-get install -y debian-archive-keyring debian-keyring

      - name: Make scripts executable
        run: |
          chmod +x build_final.sh || true
          chmod +x finalize_titan_oblivion.sh || true
          chmod +x scripts/*.sh || true

      - name: Prepare build environment
        run: |
          # Increase available memory for debootstrap
          sudo sysctl -w vm.max_map_count=262144
          
          # Clean previous build
          cd iso
          sudo lb clean --all || true
          cd ..
          
          # Fix debootstrap extraction issues
          sudo mkdir -p /var/cache/apt/archives
          sudo chmod 777 /var/cache/apt/archives

      - name: Run final fusion build with retry
        run: |
          set -e
          echo "Starting TITAN V7.0.3 ISO build..."
          
          # Attempt build with exponential backoff retry
          MAX_ATTEMPTS=2
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Build attempt $ATTEMPT/$MAX_ATTEMPTS..."
            if ./build_final.sh 2>&1 | tee build-execution.log; then
              echo "Build successful!"
              break
            else
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Build failed, cleaning and retrying..."
                cd iso
                sudo lb clean --all || true
                cd ..
                sleep 10
              else
                echo "Build failed after $MAX_ATTEMPTS attempts"
                exit 1
              fi
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Check build output
        if: always()
        run: |
          echo "Checking for ISO files..."
          find . -name "*.iso" -o -name "*.hybrid.iso" 2>/dev/null || echo "No ISO found yet"
          echo "Build log tail (last 50 lines):"
          tail -50 titan_v7_final.log 2>/dev/null || tail -50 build-execution.log || echo "No build log available"

      - name: Upload ISO artifact
        if: success() && (exists('iso/live-image-amd64.hybrid.iso') || exists('iso/live-image-amd64.iso'))
        uses: actions/upload-artifact@v4
        with:
          name: titan-iso
          path: |
            iso/live-image-amd64.hybrid.iso
            iso/live-image-amd64.iso
          retention-days: 30

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: |
            titan_v7_final.log
            build-execution.log
            iso/build.log
          retention-days: 7
