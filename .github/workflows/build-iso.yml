name: Build TITAN V7.0.3 SINGULARITY ISO

# ══════════════════════════════════════════════════════════════════════════════
# TITAN V7.0.3 SINGULARITY — Architectural Diagnostic + Oblivion Protocol
# AUTHORITY: Dva.12 | STATUS: OBLIVION_ACTIVE
#
# Mandate:
#   1. Inject Trinity Engine (Genesis, Cerberus, KYC) into live-build chroot
#   2. Compile titan_hw DKMS module + network_shield eBPF bytecode
#   3. Execute finalize_titan_oblivion.sh (AI attribution strip + sysctl hardening)
#   4. Build ISO via Debian live-build 20230502 with SOURCE_DATE_EPOCH pinning
# ══════════════════════════════════════════════════════════════════════════════

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (full/standard/minimal)'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - standard
          - minimal

env:
  ISO_NAME: titan-v7.0.3-singularity
  DEBIAN_VERSION: bookworm
  TITAN_VERSION: 7.0.3
  SOURCE_DATE_EPOCH: "1707840000"

jobs:
  build-titan-iso:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # ── PHASE 0: ACQUISITION ────────────────────────────────────────────────
      - name: Checkout Codebase
        uses: actions/checkout@v4
        with:
          path: titan-main

      - name: Free Disk Space (Maximize Storage)
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc \
            "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          df -h

      # ── PHASE 1: TOOLCHAIN INJECTION ────────────────────────────────────────
      - name: Install Build Dependencies (The Forge)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            live-build debootstrap squashfs-tools xorriso \
            isolinux syslinux-common syslinux-utils \
            dosfstools mtools genisoimage \
            gcc clang llvm make bc \
            libbpf-dev libelf-dev zlib1g-dev \
            python3 python3-pip git dkms \
            curl wget rsync cpio gettext \
            linux-headers-$(uname -r) linux-tools-common linux-tools-generic \
            debian-archive-keyring
          sudo modprobe loop || echo "[!] Loop module unavailable (expected in CI)"
          lb --version

      # ── PHASE 2: SOURCE INTEGRITY & SYNC ────────────────────────────────────
      - name: Synchronize Core Modules (Brain Transplant)
        working-directory: titan-main
        run: |
          set -euo pipefail

          sudo mkdir -p iso/config/includes.chroot/opt/titan/core
          sudo mkdir -p iso/config/includes.chroot/opt/titan/ebpf
          sudo mkdir -p iso/config/includes.chroot/usr/src/titan-hw-${TITAN_VERSION}

          echo "[*] Syncing Trinity Engine into chroot..."
          sudo rsync -a titan/core/ iso/config/includes.chroot/opt/titan/core/

          if [ -d titan/apps ]; then
            sudo rsync -a titan/apps/ iso/config/includes.chroot/opt/titan/apps/
          fi

          if [ -d titan/bin ]; then
            sudo rsync -a titan/bin/ iso/config/includes.chroot/opt/titan/bin/
          fi

          if [ -d titan/extensions ]; then
            sudo rsync -a titan/extensions/ iso/config/includes.chroot/opt/titan/extensions/
          fi

          if [ -d titan/hardware_shield ]; then
            sudo rsync -a titan/hardware_shield/ iso/config/includes.chroot/usr/src/titan-hw-${TITAN_VERSION}/
          fi

          if [ ! -f iso/config/includes.chroot/opt/titan/core/genesis_core.py ]; then
            echo "[!] CRITICAL: genesis_core.py missing after sync"
            exit 1
          fi

      # ── PHASE 3: KERNEL SHIELD PREPARATION (DKMS) ──────────────────────────
      - name: Generate DKMS Configurations
        working-directory: titan-main
        run: |
          set -euo pipefail

          DKMS_DIR="iso/config/includes.chroot/usr/src/titan-hw-${TITAN_VERSION}"
          sudo mkdir -p "$DKMS_DIR"

          if [ ! -f "$DKMS_DIR/titan_hw.c" ]; then
            echo "[!] titan_hw.c missing — synthesizing stub"
            sudo tee "$DKMS_DIR/titan_hw.c" > /dev/null <<'EOF'
#include <linux/module.h>
#include <linux/kernel.h>
MODULE_LICENSE("GPL");
MODULE_DESCRIPTION("TITAN Hardware Shield Stub");
static int __init titan_hw_init(void) { printk(KERN_INFO "TITAN HW: Loaded\n"); return 0; }
static void __exit titan_hw_exit(void) { printk(KERN_INFO "TITAN HW: Unloaded\n"); }
module_init(titan_hw_init);
module_exit(titan_hw_exit);
EOF
          fi

          echo "[*] Generating Kernel Module Makefile..."
          sudo tee "$DKMS_DIR/Makefile" > /dev/null <<'EOF'
obj-m += titan_hw.o titan_battery.o

all:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

clean:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
EOF

          echo "[*] Generating dkms.conf..."
          sudo tee "$DKMS_DIR/dkms.conf" > /dev/null <<EOF
PACKAGE_NAME="titan-hw"
PACKAGE_VERSION="${TITAN_VERSION}"
BUILT_MODULE_NAME="titan_hw"
BUILT_MODULE_LOCATION="."
DEST_MODULE_LOCATION="/kernel/drivers/misc"
AUTOINSTALL="yes"
MAKE[0]="make -C /lib/modules/\${kernelver}/build M=\${dkms_tree}/\${PACKAGE_NAME}/\${PACKAGE_VERSION}/build modules"
CLEAN="make -C /lib/modules/\${kernelver}/build M=\${dkms_tree}/\${PACKAGE_NAME}/\${PACKAGE_VERSION}/build clean"
EOF

      # ── PHASE 4: NETWORK SHIELD COMPILATION (eBPF) ──────────────────────────
      - name: Compile eBPF Network Shield
        working-directory: titan-main
        run: |
          set -euo pipefail

          if [ -f titan/ebpf/network_shield.c ]; then
            echo "[*] Compiling eBPF network_shield.c → network_shield.o"
            pushd titan/ebpf > /dev/null
            clang -O2 -target bpf -c network_shield.c -o network_shield.o
            sudo cp network_shield.o ../../iso/config/includes.chroot/opt/titan/ebpf/
            popd > /dev/null
          else
            echo "[!] WARNING: titan/ebpf/network_shield.c missing — skipping host compile"
          fi

      # ── PHASE 5: OBLIVION PROTOCOL (HARDENING) ──────────────────────────────
      - name: Execute Finalization & Hardening Protocol
        working-directory: titan-main
        run: |
          set -euo pipefail

          if [ -d "config/includes.chroot" ]; then
            sudo rsync -a config/includes.chroot/ iso/config/includes.chroot/
          fi

          if [ -f "iso/finalize_titan_oblivion.sh" ]; then
            chmod +x iso/finalize_titan_oblivion.sh
            echo "[*] Engaging Oblivion Protocol..."
            sudo ./iso/finalize_titan_oblivion.sh
          elif [ -f "finalize_titan_oblivion.sh" ]; then
            chmod +x finalize_titan_oblivion.sh
            echo "[*] Engaging Oblivion Protocol (root variant)..."
            sudo ./finalize_titan_oblivion.sh
          else
            echo "[!] CRITICAL: finalize_titan_oblivion.sh missing"
            exit 1
          fi

      # ── PHASE 6: FUSION (live-build) ────────────────────────────────────────
      - name: Configure live-build
        working-directory: titan-main/iso
        run: |
          set -euo pipefail
          sudo lb clean --purge 2>/dev/null || true
          bash auto/config

      - name: Build TITAN Singularity ISO
        id: build_iso
        working-directory: titan-main/iso
        run: |
          set -euo pipefail
          echo "[*] Initiating TITAN Singularity Build (this may take 90+ minutes)..."
          BUILD_START=$(date +%s)

          if ! sudo -E lb build 2>&1 | tee build.log; then
            echo "[!] lb build failed — tailing last 200 lines"
            tail -200 build.log
            exit 1
          fi

          BUILD_END=$(date +%s)
          echo "[+] Build completed in $(((BUILD_END - BUILD_START) / 60)) minutes"

          ISO_FILE="$(ls -1 live-image-amd64*.iso 2>/dev/null | head -1)"
          if [ -z "$ISO_FILE" ]; then
            echo "[!] ISO artifact not found"
            exit 1
          fi

          mv "$ISO_FILE" ../${ISO_NAME}.iso
          pushd .. > /dev/null
          sha256sum ${ISO_NAME}.iso > ${ISO_NAME}.iso.sha256
          md5sum ${ISO_NAME}.iso > ${ISO_NAME}.iso.md5
          popd > /dev/null

          echo "status=success" >> "$GITHUB_OUTPUT"

      # ── PHASE 7: ARTIFACT EXFILTRATION ──────────────────────────────────────
      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: titan-v7.0.3-singularity-iso
          path: |
            titan-main/${{ env.ISO_NAME }}.iso
            titan-main/${{ env.ISO_NAME }}.iso.sha256
            titan-main/${{ env.ISO_NAME }}.iso.md5
          retention-days: 5
          compression-level: 0
          if-no-files-found: error

      - name: "Upload build log"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-log
          path: titan-main/iso/build.log
          retention-days: 5
          path: iso/build.log
          retention-days: 7

  # ══════════════════════════════════════════════════════════════════════════
  # RELEASE JOB — Creates GitHub Release on tag push
  # ══════════════════════════════════════════════════════════════════════════
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ./release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/${{ env.ISO_NAME }}.iso
            release/${{ env.ISO_NAME }}.iso.sha256
            release/${{ env.ISO_NAME }}.iso.md5
          body: |
            ## TITAN V7.0 SINGULARITY Release

            ### Bootable ISO — Operational on First Boot

            **Target Success Rate: 92-96% (Tier 1 targets)**

            #### What's Inside the ISO
            - **41 Core Modules** — Full V7.0 operational stack
            - **1 Unified GUI** — Operation + Intelligence + Shields + KYC in single app
            - **Camoufox Anti-Detect Browser** — Pre-installed with 15+ hardening configs
            - **Ghost Motor Extension** — Diffusion-based behavioral biometrics evasion
            - **32 Pre-Configured Targets** — Fraud engine + PSP intelligence database
            - **VPS Disk Installer** — Install to VPS disk for persistent deployment
            - **First-Boot Service** — Auto-verifies and completes setup on first boot
            - **Phase 3 Hardening** — Font, audio, timezone atomicity shields

            #### Desktop (3 Icons — Zero Terminal)
            | Icon | Function |
            |------|----------|
            | **TITAN V7.0** | Unified Operation Center (4 tabs: OPS, INTEL, SHIELDS, KYC) |
            | **Titan Browser** | Hardened Camoufox with all shields |
            | **Install to Disk** | VPS/bare metal persistent installer |

            #### Core Modules (30)
            `genesis_core` · `target_intelligence` · `preflight_validator` ·
            `cerberus_core` · `cerberus_enhanced` · `fingerprint_injector` ·
            `handover_protocol` · `integration_bridge` · `ghost_motor_v6` ·
            `cognitive_core` · `referrer_warmup` · `proxy_manager` ·
            `three_ds_strategy` · `target_presets` · `quic_proxy` ·
            `kyc_core` · `kyc_enhanced` · `lucid_vpn` ·
            `purchase_history_engine` · `kill_switch` · `font_sanitizer` ·
            `audio_hardener` · `timezone_enforcer` · `verify_deep_identity` ·
            `titan_master_verify` · `advanced_profile_generator` ·
            `location_spoofer_linux` · `form_autofill_injector` ·
            `hardware_shield_v6.c` · `network_shield_v6.c`

            #### First Boot
            ```
            1. Write ISO to USB: sudo dd if=lucid-titan-v7.0-singularity.iso of=/dev/sdX bs=4M status=progress
            2. Boot from USB
            3. System auto-runs first-boot service (installs Camoufox, verifies 41 modules)
            4. GUI auto-launches — 3 desktop icons ready
            5. System is OPERATIONAL
            ```

            #### VPS Install
            ```
            # From within the booted live ISO:
            sudo bash /opt/titan/bin/install-to-disk /dev/vda
            # Reboot — system persists permanently
            # Access: SSH root@<IP> or VNC <IP>:5901
            ```

            ### Checksums
            See `.sha256` and `.md5` files for verification.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ══════════════════════════════════════════════════════════════════════════
  # VALIDATE JOB — Runs on pull requests
  # ══════════════════════════════════════════════════════════════════════════
  validate:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ./validate

      - name: Validate ISO
        run: |
          cd validate
          if [ -f ${{ env.ISO_NAME }}.iso ]; then
            echo "══════════════════════════════════════════════════"
            echo "  ISO Validation"
            echo "══════════════════════════════════════════════════"
            ls -lh ${{ env.ISO_NAME }}.iso

            # Verify checksum
            sha256sum -c ${{ env.ISO_NAME }}.iso.sha256
            echo "[+] SHA256 checksum verified"

            # Check ISO structure
            sudo apt-get install -y genisoimage 2>/dev/null || true
            isoinfo -d -i ${{ env.ISO_NAME }}.iso | head -20 || true
          else
            echo "ISO not found!"
            exit 1
          fi
