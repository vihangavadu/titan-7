# ============================================================================
# DEPRECATED: This is the legacy V6.0 SOVEREIGN build workflow.
# Use build-iso.yml (V7.0 SINGULARITY) instead.
# This file is kept for historical reference only. All triggers are disabled.
# ============================================================================
#
# TITAN V6.0 SOVEREIGN - Automated Build Pipeline (DEPRECATED)
# Containerized GitHub Actions workflow for reproducible ISO generation

name: "[DEPRECATED] Titan V6 Sovereign Build"

on:
  # ALL TRIGGERS DISABLED - Use build-iso.yml for V7.0 builds
  workflow_dispatch:
    inputs:
      target_cloud:
        description: 'Target Cloud Provider'
        required: true
        default: 'kamatera'
        type: choice
        options:
          - kamatera
          - vultr
          - aws
          - generic
      build_type:
        description: 'Build Type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - iso-only
          - qcow2-only

env:
  TITAN_VERSION: "6.0.0"
  TITAN_CODENAME: "SOVEREIGN"
  ISO_NAME: "lucid-titan-v6.0-sovereign"
  DEBIAN_VERSION: "bookworm"

jobs:
  build-sovereign-core:
    name: Build Titan V6 Sovereign ISO
    runs-on: ubuntu-24.04
    container:
      image: debian:bookworm
      options: --privileged  # Required for loopback mounting (kpartx/losetup)
    
    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Cache APT Packages
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/archives
          /var/lib/apt/lists
        key: ${{ runner.os }}-titan-v6-apt-${{ hashFiles('iso/config/package-lists/*.list') }}
        restore-keys: |
          ${{ runner.os }}-titan-v6-apt-

    - name: Cache Live-Build
      uses: actions/cache@v4
      with:
        path: |
          iso/cache
          iso/.build
        key: ${{ runner.os }}-titan-v6-lb-${{ hashFiles('iso/config/**') }}
        restore-keys: |
          ${{ runner.os }}-titan-v6-lb-

    - name: Install Build Toolchain
      run: |
        echo "[+] Installing Titan V6 Build Toolchain..."
        apt-get update -qq
        
        # Core build tools
        apt-get install -y --no-install-recommends \
          live-build \
          debootstrap \
          squashfs-tools \
          xorriso \
          isolinux \
          syslinux-common \
          grub-pc-bin \
          grub-efi-amd64-bin \
          mtools \
          dosfstools
        
        # Kernel module compilation
        apt-get install -y --no-install-recommends \
          build-essential \
          linux-headers-amd64 \
          dkms \
          kmod
        
        # eBPF toolchain (CO-RE)
        apt-get install -y --no-install-recommends \
          clang-15 \
          llvm-15 \
          libbpf-dev \
          libelf-dev \
          zlib1g-dev
        
        # Cloud image tools
        apt-get install -y --no-install-recommends \
          qemu-utils \
          kpartx \
          parted \
          e2fsprogs
        
        # Python for scripts
        apt-get install -y --no-install-recommends \
          python3 \
          python3-pip
        
        echo "[+] Toolchain installation complete"

    - name: Prepare DKMS Module Source
      run: |
        echo "[+] Preparing Hardware Shield V6 for DKMS..."
        
        # Create DKMS source directory
        DKMS_SRC="iso/config/includes.chroot/usr/src/titan-hw-${TITAN_VERSION}"
        mkdir -p "$DKMS_SRC"
        
        # Copy V6 hardware shield source
        if [ -f "iso/config/includes.chroot/opt/titan/core/hardware_shield_v6.c" ]; then
          cp iso/config/includes.chroot/opt/titan/core/hardware_shield_v6.c "$DKMS_SRC/titan_hw.c"
        elif [ -f "titan/hardware_shield/titan_hw.c" ]; then
          cp titan/hardware_shield/titan_hw.c "$DKMS_SRC/"
        fi
        
        # Create Makefile
        cat > "$DKMS_SRC/Makefile" << 'EOF'
        obj-m += titan_hw.o
        
        KVERSION ?= $(shell uname -r)
        KDIR ?= /lib/modules/$(KVERSION)/build
        
        all:
        	$(MAKE) -C $(KDIR) M=$(PWD) modules
        
        clean:
        	$(MAKE) -C $(KDIR) M=$(PWD) clean
        
        install:
        	$(MAKE) -C $(KDIR) M=$(PWD) modules_install
        	depmod -a
        EOF
        
        # Create DKMS configuration
        cat > "$DKMS_SRC/dkms.conf" << EOF
        PACKAGE_NAME="titan-hw"
        PACKAGE_VERSION="${TITAN_VERSION}"
        BUILT_MODULE_NAME[0]="titan_hw"
        DEST_MODULE_LOCATION[0]="/kernel/drivers/misc"
        AUTOINSTALL="yes"
        MAKE[0]="make -C \${kernel_source_dir} M=\${dkms_tree}/\${PACKAGE_NAME}/\${PACKAGE_VERSION}/build modules"
        CLEAN="make -C \${kernel_source_dir} M=\${dkms_tree}/\${PACKAGE_NAME}/\${PACKAGE_VERSION}/build clean"
        EOF
        
        echo "[+] DKMS source prepared at $DKMS_SRC"

    - name: Compile eBPF Network Shield (CO-RE)
      run: |
        echo "[+] Compiling Network Shield V6 (CO-RE)..."
        
        # Create output directory
        mkdir -p iso/config/includes.chroot/lib/firmware/titan
        
        # Find the network shield source
        NET_SHIELD=""
        if [ -f "iso/config/includes.chroot/opt/titan/core/network_shield_v6.c" ]; then
          NET_SHIELD="iso/config/includes.chroot/opt/titan/core/network_shield_v6.c"
        elif [ -f "titan/ebpf/network_shield.c" ]; then
          NET_SHIELD="titan/ebpf/network_shield.c"
        fi
        
        if [ -n "$NET_SHIELD" ]; then
          # Compile with CO-RE (Compile Once, Run Everywhere)
          clang-15 -O2 -g -target bpf \
            -D__TARGET_ARCH_x86 \
            -I/usr/include/x86_64-linux-gnu \
            -c "$NET_SHIELD" \
            -o iso/config/includes.chroot/lib/firmware/titan/network_shield.o || true
          
          echo "[+] Network Shield compiled (or skipped if source missing)"
        else
          echo "[!] Network Shield source not found, skipping..."
        fi

    - name: Configure Live-Build
      run: |
        echo "[+] Configuring Live-Build for Titan V6..."
        cd iso
        
        # Clean previous builds
        lb clean --purge 2>/dev/null || true
        
        # Configure live-build
        lb config \
          --distribution "$DEBIAN_VERSION" \
          --archive-areas "main contrib non-free non-free-firmware" \
          --architectures amd64 \
          --binary-images iso-hybrid \
          --bootappend-live "boot=live persistence quiet splash titan_shield=active" \
          --debian-installer false \
          --iso-application "LUCID EMPIRE TITAN V${TITAN_VERSION}" \
          --iso-publisher "Dva.12" \
          --iso-volume "TITAN-V6-SOVEREIGN" \
          --memtest none \
          --win32-loader false \
          --apt-indices false \
          --apt-recommends false \
          --security true \
          --updates true
        
        echo "[+] Live-Build configured"

    - name: Build ISO
      run: |
        echo "[+] Building Titan V6 Sovereign ISO..."
        cd iso
        
        # Set build timestamp for reproducibility
        export SOURCE_DATE_EPOCH=$(git log -1 --format=%ct 2>/dev/null || date +%s)
        
        # Build
        lb build 2>&1 | tee ../build.log
        
        # Check for output
        if ls live-image-*.iso 1>/dev/null 2>&1; then
          mv live-image-*.iso "../${ISO_NAME}.iso"
          echo "[+] ISO built successfully: ${ISO_NAME}.iso"
          ls -lh "../${ISO_NAME}.iso"
        else
          echo "[!] ISO build failed, checking logs..."
          tail -100 ../build.log
          exit 1
        fi

    - name: Generate ISO Checksums
      run: |
        echo "[+] Generating checksums..."
        
        if [ -f "${ISO_NAME}.iso" ]; then
          sha256sum "${ISO_NAME}.iso" > "${ISO_NAME}.iso.sha256"
          sha512sum "${ISO_NAME}.iso" > "${ISO_NAME}.iso.sha512"
          md5sum "${ISO_NAME}.iso" > "${ISO_NAME}.iso.md5"
          
          echo "SHA256: $(cat ${ISO_NAME}.iso.sha256)"
        fi

    - name: Synthesize Cloud Image (QCOW2)
      if: false
      run: |
        echo "[+] Synthesizing QCOW2 cloud image..."
        
        if [ ! -f "${ISO_NAME}.iso" ]; then
          echo "[!] ISO not found, skipping QCOW2 generation"
          exit 0
        fi
        
        # Create raw disk (10GB for V6 expanded capabilities)
        qemu-img create -f raw titan_v6.raw 10G
        
        # Partition disk (GPT with EFI + Root)
        parted -s titan_v6.raw mklabel gpt
        parted -s titan_v6.raw mkpart primary fat32 1MiB 257MiB
        parted -s titan_v6.raw set 1 esp on
        parted -s titan_v6.raw mkpart primary ext4 257MiB 100%
        
        # Setup loop device
        LOOP_DEV=$(losetup -f --show titan_v6.raw)
        kpartx -av "$LOOP_DEV"
        
        # Get partition devices
        LOOP_NAME=$(basename "$LOOP_DEV")
        EFI_PART="/dev/mapper/${LOOP_NAME}p1"
        ROOT_PART="/dev/mapper/${LOOP_NAME}p2"
        
        # Format partitions
        mkfs.vfat -F 32 "$EFI_PART"
        mkfs.ext4 -F "$ROOT_PART"
        
        # Mount and extract
        mkdir -p /mnt/titan_root /mnt/titan_efi /mnt/titan_iso
        mount "$ROOT_PART" /mnt/titan_root
        mount "$EFI_PART" /mnt/titan_efi
        mount -o loop "${ISO_NAME}.iso" /mnt/titan_iso
        
        # Extract squashfs
        if [ -f /mnt/titan_iso/live/filesystem.squashfs ]; then
          unsquashfs -f -d /mnt/titan_root /mnt/titan_iso/live/filesystem.squashfs
        fi
        
        # Setup EFI
        mkdir -p /mnt/titan_efi/EFI/BOOT
        if [ -d /mnt/titan_iso/EFI ]; then
          cp -r /mnt/titan_iso/EFI/* /mnt/titan_efi/EFI/
        fi
        
        # Cleanup mounts
        umount /mnt/titan_iso || true
        umount /mnt/titan_efi || true
        umount /mnt/titan_root || true
        kpartx -dv "$LOOP_DEV" || true
        losetup -d "$LOOP_DEV" || true
        
        # Convert to QCOW2 with compression
        qemu-img convert -c -f raw -O qcow2 titan_v6.raw "${ISO_NAME}.qcow2"
        rm -f titan_v6.raw
        
        # Generate checksum
        sha256sum "${ISO_NAME}.qcow2" > "${ISO_NAME}.qcow2.sha256"
        
        echo "[+] QCOW2 image created: ${ISO_NAME}.qcow2"
        ls -lh "${ISO_NAME}.qcow2"

    - name: Upload ISO Artifact
      uses: actions/upload-artifact@v4
      with:
        name: titan-v6-iso
        path: |
          ${{ env.ISO_NAME }}.iso
          ${{ env.ISO_NAME }}.iso.sha256
          ${{ env.ISO_NAME }}.iso.sha512
        retention-days: 7
        if-no-files-found: warn

    - name: Upload QCOW2 Artifact
      if: ${{ github.event.inputs.build_type != 'iso-only' }}
      uses: actions/upload-artifact@v4
      with:
        name: titan-v6-qcow2
        path: |
          ${{ env.ISO_NAME }}.qcow2
          ${{ env.ISO_NAME }}.qcow2.sha256
        retention-days: 7
        if-no-files-found: warn

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: titan-v6-build-logs
        path: |
          build.log
          iso/binary.log
          iso/build.log
        retention-days: 3
        if-no-files-found: ignore

    - name: Build Summary
      run: |
        echo "## Titan V6 Sovereign Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version | ${TITAN_VERSION} |" >> $GITHUB_STEP_SUMMARY
        echo "| Codename | ${TITAN_CODENAME} |" >> $GITHUB_STEP_SUMMARY
        echo "| Base | Debian ${DEBIAN_VERSION} |" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "${ISO_NAME}.iso" ]; then
          ISO_SIZE=$(ls -lh "${ISO_NAME}.iso" | awk '{print $5}')
          ISO_SHA=$(cat "${ISO_NAME}.iso.sha256" | awk '{print $1}')
          echo "| ISO Size | ${ISO_SIZE} |" >> $GITHUB_STEP_SUMMARY
          echo "| ISO SHA256 | \`${ISO_SHA:0:16}...\` |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "${ISO_NAME}.qcow2" ]; then
          QCOW_SIZE=$(ls -lh "${ISO_NAME}.qcow2" | awk '{print $5}')
          echo "| QCOW2 Size | ${QCOW_SIZE} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### V6 Features" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Cloud Cognitive Core (vLLM integration)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ DMTG Diffusion Mouse Trajectories" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Transparent QUIC Proxy" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Dynamic Netlink Hardware Injection" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ DKMS Kernel Module" >> $GITHUB_STEP_SUMMARY

  # Optional: Deploy to cloud provider
  deploy-cloud:
    name: Deploy to Cloud
    needs: build-sovereign-core
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_cloud != 'generic' }}
    
    steps:
    - name: Download QCOW2
      uses: actions/download-artifact@v4
      with:
        name: titan-v6-qcow2

    - name: Deploy to ${{ github.event.inputs.target_cloud }}
      run: |
        echo "[+] Deployment to ${{ github.event.inputs.target_cloud }} would happen here"
        echo "[!] Cloud deployment requires API credentials in secrets"
        # In production:
        # - Kamatera: Use their API to upload and create server
        # - Vultr: Use vultr-cli or API
        # - AWS: Use aws-cli to upload to S3 and import as AMI
