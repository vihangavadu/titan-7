#!/usr/sbin/nft -f
# TITAN V7.0 SINGULARITY — Default-Deny Firewall
# All 3 chains: policy drop (true default-deny)

flush ruleset

table inet titan_firewall {

    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback
        iif "lo" accept

        # Established/related connections
        ct state established,related accept

        # PORT CLOAKING: Explicitly reject probes to internal TITAN ports
        # These return RST (not DROP) to mimic "port closed" not "filtered"
        tcp dport { 8080, 8443, 9050, 3128, 8000, 8001 } reject with tcp reset

        # ICMP (rate-limited)
        ip protocol icmp limit rate 10/second accept
        ip6 nexthdr icmpv6 limit rate 10/second accept

        # SSH (local management only — restrict to LAN if needed)
        tcp dport 22 accept

        # DHCP client
        udp sport 67 udp dport 68 accept

        # WebRTC STUN/TURN leak prevention: drop unsolicited UDP
        udp dport { 3478, 5349, 19302 } drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
        # No forwarding allowed
    }

    chain output {
        type filter hook output priority 0; policy drop;

        # Loopback
        oif "lo" accept

        # Established/related
        ct state established,related accept

        # DNS (local Unbound resolver)
        udp dport 53 accept
        tcp dport 53 accept

        # DNS-over-TLS (Unbound → Cloudflare/Quad9)
        tcp dport 853 accept

        # HTTP/HTTPS (browser traffic)
        tcp dport 80 accept
        tcp dport 443 accept

        # QUIC (HTTP/3)
        udp dport 443 accept

        # SOCKS/Proxy ports
        tcp dport { 1080, 3128, 8080, 8443, 9050 } accept

        # Xray/VLESS
        tcp dport 8443 accept

        # Tailscale VPN
        udp dport 41641 accept

        # Cloud Brain (Ollama/vLLM)
        tcp dport { 8000, 8001 } accept

        # NTP (time sync)
        udp dport 123 accept

        # SSH outbound
        tcp dport 22 accept

        # DHCP
        udp sport 68 udp dport 67 accept
    }
}
