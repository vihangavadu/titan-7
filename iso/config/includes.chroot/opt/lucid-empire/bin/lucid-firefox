#!/bin/bash
# LUCID EMPIRE :: FIREFOX LAUNCHER (SHIELDED)
# AUTHORITY: Dva.12 | TITAN V5 FINAL
# PURPOSE: Launch Standard Firefox ESR with Hardware Shield + Profile Grafting

set -e

LUCID_ROOT="/opt/lucid-empire"
PROFILES_DIR="$LUCID_ROOT/profiles"
ACTIVE_PROFILE="$PROFILES_DIR/active"

# ============================================================================
# ARGUMENT PARSING
# ============================================================================
PROFILE_NAME=""
URL=""
DEBUG_MODE=0

while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--profile)
            PROFILE_NAME="$2"
            shift 2
            ;;
        -d|--debug)
            DEBUG_MODE=1
            shift
            ;;
        -h|--help)
            echo "LUCID Firefox Launcher (No-Fork Edition)"
            echo ""
            echo "Usage: lucid-firefox [OPTIONS] [URL]"
            echo ""
            echo "Options:"
            echo "  -p, --profile NAME    Use specific profile (default: active)"
            echo "  -d, --debug           Enable debug output"
            echo "  -h, --help            Show this help"
            echo ""
            echo "The launcher:"
            echo "  1. Activates Hardware Shield (LD_PRELOAD)"
            echo "  2. Sets timezone from profile"
            echo "  3. Exports hardware spoofing variables"
            echo "  4. Launches standard Firefox ESR with grafted profile"
            exit 0
            ;;
        *)
            URL="$1"
            shift
            ;;
    esac
done

# ============================================================================
# PROFILE RESOLUTION
# ============================================================================
if [[ -n "$PROFILE_NAME" ]]; then
    PROFILE_PATH="$PROFILES_DIR/$PROFILE_NAME"
    if [[ ! -d "$PROFILE_PATH" ]]; then
        echo "[ERROR] Profile not found: $PROFILE_NAME"
        echo "Available profiles:"
        ls -1 "$PROFILES_DIR" 2>/dev/null | grep -v "^active$" || echo "  (none)"
        exit 1
    fi
else
    PROFILE_PATH="$ACTIVE_PROFILE"
fi

# Verify profile exists
if [[ ! -d "$PROFILE_PATH" ]]; then
    echo "[ERROR] No active profile. Run Genesis Engine first:"
    echo "  lucid-genesis --preset us_ecom_premium"
    exit 1
fi

# Firefox profile subdirectory
FIREFOX_PROFILE="$PROFILE_PATH/firefox_profile"
if [[ ! -d "$FIREFOX_PROFILE" ]]; then
    echo "[ERROR] Firefox profile not found at: $FIREFOX_PROFILE"
    echo "Profile may not have been initialized correctly."
    exit 1
fi

# ============================================================================
# ENVIRONMENT SETUP: THE HARDWARE SHIELD
# ============================================================================
export LUCID_PROFILE_PATH="$PROFILE_PATH"

# Load hardware configuration
if [[ -f "$PROFILE_PATH/hardware.conf" ]]; then
    source "$PROFILE_PATH/hardware.conf" 2>/dev/null || true
fi

# Screen resolution spoofing
export LUCID_SCREEN_WIDTH="${SCREEN_WIDTH:-1920}"
export LUCID_SCREEN_HEIGHT="${SCREEN_HEIGHT:-1080}"

# Timezone binding
if [[ -f "$PROFILE_PATH/timezone" ]]; then
    export TZ=$(cat "$PROFILE_PATH/timezone")
fi

# Locale binding
if [[ -f "$PROFILE_PATH/locale" ]]; then
    export LANG=$(cat "$PROFILE_PATH/locale")
    export LC_ALL=$(cat "$PROFILE_PATH/locale")
fi

# Language binding (for Accept-Language header)
if [[ -f "$PROFILE_PATH/language" ]]; then
    export LANGUAGE=$(cat "$PROFILE_PATH/language")
fi

# Debug mode
if [[ $DEBUG_MODE -eq 1 ]]; then
    export LUCID_DEBUG=1
    echo "[LUCID] Profile: $PROFILE_PATH"
    echo "[LUCID] Timezone: $TZ"
    echo "[LUCID] Screen: ${LUCID_SCREEN_WIDTH}x${LUCID_SCREEN_HEIGHT}"
    echo "[LUCID] Hardware Shield: ACTIVE"
fi

# ============================================================================
# LD_PRELOAD: THE CORE DECEPTION
# ============================================================================
HARDWARE_SHIELD="$LUCID_ROOT/lib/libhardwareshield.so"

if [[ -f "$HARDWARE_SHIELD" ]]; then
    export LD_PRELOAD="$HARDWARE_SHIELD"
    [[ $DEBUG_MODE -eq 1 ]] && echo "[LUCID] LD_PRELOAD: $HARDWARE_SHIELD"
else
    echo "[WARNING] Hardware Shield not compiled. Run: make -C $LUCID_ROOT/lib"
fi

# ============================================================================
# FIREFOX LAUNCH: STANDARD BINARY, GRAFTED PROFILE
# ============================================================================

# User.js overrides for additional hardening
USER_JS="$FIREFOX_PROFILE/user.js"
if [[ ! -f "$USER_JS" ]]; then
    cat > "$USER_JS" << 'USERJS'
// LUCID EMPIRE :: Firefox Hardening (Runtime Injection)
// These settings complement the Hardware Shield

// Disable telemetry
user_pref("toolkit.telemetry.enabled", false);
user_pref("datareporting.healthreport.uploadEnabled", false);

// Disable WebRTC IP leak
user_pref("media.peerconnection.ice.default_address_only", true);
user_pref("media.peerconnection.ice.proxy_only_if_behind_proxy", true);

// Disable battery API
user_pref("dom.battery.enabled", false);

// Disable gamepad API (fingerprinting vector)
user_pref("dom.gamepad.enabled", false);

// Disable sensor APIs
user_pref("device.sensors.enabled", false);

// Consistent font fingerprint
user_pref("browser.display.use_document_fonts", 1);
user_pref("gfx.downloadable_content.enabled", true);

// Disable resistance fingerprinting (we handle this ourselves)
// Firefox's built-in RFP creates detectable anomalies
user_pref("privacy.resistFingerprinting", false);

// Enable smooth scrolling (human behavior)
user_pref("general.smoothScroll", true);

// Set profile-specific homepage (loaded from profile)
// user_pref("browser.startup.homepage", "about:blank");
USERJS
fi

# Build Firefox arguments
FIREFOX_ARGS=(
    "--profile" "$FIREFOX_PROFILE"
    "--no-remote"
)

# Add URL if provided
[[ -n "$URL" ]] && FIREFOX_ARGS+=("$URL")

# ============================================================================
# EXECUTION: THE HANDOVER IS COMPLETE
# ============================================================================
[[ $DEBUG_MODE -eq 1 ]] && echo "[LUCID] Launching: firefox-esr ${FIREFOX_ARGS[*]}"

exec firefox-esr "${FIREFOX_ARGS[@]}"
