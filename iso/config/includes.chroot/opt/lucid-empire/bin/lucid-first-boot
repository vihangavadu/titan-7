#!/bin/bash
# =============================================================================
# LUCID EMPIRE TITAN - First Boot Configuration
# =============================================================================
# Interactive setup wizard for first-time ISO boot
# =============================================================================

set -e

TITAN_HOME="/opt/lucid-empire"
CONFIG_DIR="${TITAN_HOME}/config"
LOG_FILE="/var/log/lucid-first-boot.log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo -e "${GREEN}[✓]${NC} $1"
}

warn() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] WARNING: $1" >> "$LOG_FILE"
    echo -e "${YELLOW}[!]${NC} $1"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" >> "$LOG_FILE"
    echo -e "${RED}[✗]${NC} $1" >&2
}

print_banner() {
    clear
    echo -e "${CYAN}"
    echo "╔══════════════════════════════════════════════════════════════════════════╗"
    echo "║                                                                          ║"
    echo "║   ██╗     ██╗   ██╗ ██████╗██╗██████╗     ███████╗███╗   ███╗██████╗    ║"
    echo "║   ██║     ██║   ██║██╔════╝██║██╔══██╗    ██╔════╝████╗ ████║██╔══██╗   ║"
    echo "║   ██║     ██║   ██║██║     ██║██║  ██║    █████╗  ██╔████╔██║██████╔╝   ║"
    echo "║   ██║     ██║   ██║██║     ██║██║  ██║    ██╔══╝  ██║╚██╔╝██║██╔═══╝    ║"
    echo "║   ███████╗╚██████╔╝╚██████╗██║██████╔╝    ███████╗██║ ╚═╝ ██║██║        ║"
    echo "║   ╚══════╝ ╚═════╝  ╚═════╝╚═╝╚═════╝     ╚══════╝╚═╝     ╚═╝╚═╝        ║"
    echo "║                                                                          ║"
    echo "║                      T I T A N  v7.0  -  First Boot Setup                ║"
    echo "║                                                                          ║"
    echo "╚══════════════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    echo ""
}

# Check if already configured
FIRST_BOOT_MARKER="/var/lib/lucid-empire/.first-boot-complete"
if [[ -f "$FIRST_BOOT_MARKER" ]]; then
    echo "First boot setup already completed."
    echo "To reconfigure, delete: $FIRST_BOOT_MARKER"
    exit 0
fi

print_banner

echo -e "${BOLD}Welcome to LUCID EMPIRE TITAN${NC}"
echo ""
echo "This wizard will configure your system for optimal operation."
echo "Press Enter to continue or Ctrl+C to exit..."
read

# =============================================================================
# Step 1: Network Interface Detection
# =============================================================================
echo ""
echo -e "${CYAN}[1/6] Network Interface Detection${NC}"
echo "─────────────────────────────────────────────────────────────"

PRIMARY_IF=$(ip route | grep default | awk '{print $5}' | head -1)
if [[ -z "$PRIMARY_IF" ]]; then
    PRIMARY_IF="eth0"
    warn "Could not detect primary interface, defaulting to eth0"
fi

ALL_IFS=$(ip -o link show | awk -F': ' '{print $2}' | grep -v '^lo$' | tr '\n' ' ')

echo "Detected interfaces: $ALL_IFS"
echo "Primary interface: $PRIMARY_IF"
echo ""
read -p "Use $PRIMARY_IF as primary interface? [Y/n]: " confirm
if [[ "${confirm,,}" == "n" ]]; then
    read -p "Enter interface name: " PRIMARY_IF
fi

log "Primary interface set to: $PRIMARY_IF"

# Save to config
mkdir -p "$CONFIG_DIR"
echo "PRIMARY_INTERFACE=$PRIMARY_IF" > "$CONFIG_DIR/network.conf"

# =============================================================================
# Step 2: eBPF Program Loading
# =============================================================================
echo ""
echo -e "${CYAN}[2/6] eBPF TCP Fingerprint Masquerade${NC}"
echo "─────────────────────────────────────────────────────────────"

echo "Select default TCP fingerprint profile:"
echo ""
echo "  1) Windows (TTL=128, recommended for most operations)"
echo "  2) macOS (TTL=64)"
echo "  3) Linux (TTL=64)"
echo "  4) Skip eBPF setup"
echo ""
read -p "Choice [1]: " ebpf_choice
ebpf_choice=${ebpf_choice:-1}

case "$ebpf_choice" in
    1) TCP_PROFILE="windows" ;;
    2) TCP_PROFILE="macos" ;;
    3) TCP_PROFILE="linux" ;;
    4) TCP_PROFILE="none" ;;
    *) TCP_PROFILE="windows" ;;
esac

if [[ "$TCP_PROFILE" != "none" ]]; then
    echo "TCP_PROFILE=$TCP_PROFILE" >> "$CONFIG_DIR/network.conf"
    log "TCP profile set to: $TCP_PROFILE"
    
    if [[ -x "$TITAN_HOME/bin/load-ebpf.sh" ]]; then
        echo ""
        echo "Loading eBPF program..."
        "$TITAN_HOME/bin/load-ebpf.sh" "$PRIMARY_IF" "$TCP_PROFILE" load 2>&1 | tee -a "$LOG_FILE" || {
            warn "eBPF loading failed - may require kernel 5.15+ with BTF support"
        }
    fi
else
    log "eBPF setup skipped"
fi

# =============================================================================
# Step 3: Timezone Configuration
# =============================================================================
echo ""
echo -e "${CYAN}[3/6] Timezone Configuration${NC}"
echo "─────────────────────────────────────────────────────────────"

CURRENT_TZ=$(cat /etc/timezone 2>/dev/null || echo "UTC")
echo "Current timezone: $CURRENT_TZ"
echo ""
read -p "Change timezone? [y/N]: " change_tz

if [[ "${change_tz,,}" == "y" ]]; then
    dpkg-reconfigure tzdata
fi

log "Timezone configured"

# =============================================================================
# Step 4: Services Setup
# =============================================================================
echo ""
echo -e "${CYAN}[4/6] TITAN Services Setup${NC}"
echo "─────────────────────────────────────────────────────────────"

echo "Starting LUCID Console web dashboard..."
systemctl daemon-reload

if systemctl enable lucid-console 2>/dev/null; then
    systemctl start lucid-console || warn "Console service failed to start"
    log "LUCID Console service enabled"
else
    warn "Could not enable console service"
fi

# Enable eBPF service if configured
if [[ "$TCP_PROFILE" != "none" ]]; then
    if systemctl enable lucid-ebpf 2>/dev/null; then
        log "eBPF service enabled for boot"
    fi
fi

# =============================================================================
# Step 5: First Profile Creation
# =============================================================================
echo ""
echo -e "${CYAN}[5/6] Initial Profile Creation${NC}"
echo "─────────────────────────────────────────────────────────────"

read -p "Create an initial profile? [Y/n]: " create_profile
if [[ "${create_profile,,}" != "n" ]]; then
    echo ""
    read -p "Profile name [default]: " profile_name
    profile_name=${profile_name:-default}
    
    read -p "Profile age in days [90]: " profile_age
    profile_age=${profile_age:-90}
    
    echo ""
    echo "Available templates:"
    ls -1 "$TITAN_HOME/presets/"*.json 2>/dev/null | xargs -I{} basename {} .json | nl
    echo ""
    read -p "Template [us_ecom_premium]: " template
    template=${template:-us_ecom_premium}
    
    echo ""
    echo "Creating profile: $profile_name (age: ${profile_age}d, template: $template)"
    
    if [[ -x "$TITAN_HOME/bin/lucid-profile-mgr" ]]; then
        "$TITAN_HOME/bin/lucid-profile-mgr" create "$profile_name" "$profile_age" "$template" | tee -a "$LOG_FILE"
        
        read -p "Load this profile now? [Y/n]: " load_now
        if [[ "${load_now,,}" != "n" ]]; then
            "$TITAN_HOME/bin/lucid-profile-mgr" load "$profile_name" | tee -a "$LOG_FILE"
        fi
    else
        warn "Profile manager not found"
    fi
fi

# =============================================================================
# Step 6: Hardware Shield Compilation
# =============================================================================
echo ""
echo -e "${CYAN}[6/6] Hardware Shield Compilation${NC}"
echo "─────────────────────────────────────────────────────────────"
echo -e "${YELLOW}The Hardware Shield intercepts GPU/CPU queries from browsers${NC}"
echo -e "${YELLOW}to report the identity's hardware instead of the real machine.${NC}"
echo ""

if [[ -f "$TITAN_HOME/lib/libhardwareshield.so" ]]; then
    log "Hardware Shield already compiled"
else
    read -p "Compile Hardware Shield (LD_PRELOAD library)? [Y/n]: " compile_shield
    if [[ "${compile_shield,,}" != "n" ]]; then
        if [[ -f "$TITAN_HOME/lib/Makefile" ]]; then
            echo -e "${CYAN}[*] Compiling Hardware Shield...${NC}"
            make -C "$TITAN_HOME/lib" | tee -a "$LOG_FILE"
            if [[ -f "$TITAN_HOME/lib/libhardwareshield.so" ]]; then
                log "Hardware Shield compiled successfully"
            else
                warn "Hardware Shield compilation may have failed"
            fi
        else
            warn "Hardware Shield Makefile not found"
        fi
    fi
fi

# =============================================================================
# Complete
# =============================================================================
echo ""
echo -e "${GREEN}╔══════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                     FIRST BOOT SETUP COMPLETE!                           ║${NC}"
echo -e "${GREEN}╠══════════════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${GREEN}║                                                                          ║${NC}"
echo -e "${GREEN}║  LUCID Console Dashboard: ${CYAN}http://127.0.0.1:8080${GREEN}                         ║${NC}"
echo -e "${GREEN}║                                                                          ║${NC}"
echo -e "${GREEN}║  Commands:                                                               ║${NC}"
echo -e "${GREEN}║    ${CYAN}titan console${GREEN}        - Launch TITAN Console GUI                      ║${NC}"
echo -e "${GREEN}║    ${CYAN}lucid-browser${GREEN}        - Launch browser with active profile            ║${NC}"
echo -e "${GREEN}║    ${CYAN}lucid-profile-mgr${GREEN}    - Manage identity profiles                      ║${NC}"
echo -e "${GREEN}║    ${CYAN}lucid-burn${GREEN}           - Burn current profile                          ║${NC}"
echo -e "${GREEN}║                                                                          ║${NC}"
echo -e "${GREEN}║  Configuration: $CONFIG_DIR${GREEN}                              ║${NC}"
echo -e "${GREEN}║  Log file: $LOG_FILE${GREEN}                               ║${NC}"
echo -e "${GREEN}║                                                                          ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Mark first boot complete
mkdir -p "$(dirname "$FIRST_BOOT_MARKER")"
date -u +%Y-%m-%dT%H:%M:%SZ > "$FIRST_BOOT_MARKER"

log "First boot setup completed successfully"

echo "Press Enter to continue..."
read
