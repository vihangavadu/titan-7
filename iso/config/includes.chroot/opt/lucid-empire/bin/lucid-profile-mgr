#!/bin/bash
# LUCID EMPIRE TITAN - Profile Manager CLI
# Manages identity profiles with full fingerprint and history support

set -e

TITAN_HOME="${TITAN_HOME:-/opt/lucid-empire}"
PROFILES_DIR="${HOME}/.lucid-empire/profiles"
ACTIVE_DIR="${PROFILES_DIR}/active"
BURNED_DIR="${PROFILES_DIR}/burned"
TEMPLATES_DIR="${TITAN_HOME}/presets"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║        LUCID EMPIRE TITAN - Profile Manager               ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

log() { echo -e "${GREEN}[TITAN]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

# Initialize directories
init_dirs() {
    mkdir -p "$PROFILES_DIR" "$ACTIVE_DIR" "$BURNED_DIR"
}

# Generate UUID
generate_uuid() {
    cat /proc/sys/kernel/random/uuid 2>/dev/null || \
    python3 -c "import uuid; print(uuid.uuid4())"
}

# Create new profile
cmd_create() {
    local name="$1"
    local aging="${2:-90}"
    local template="${3:-us_ecom_premium}"
    
    if [[ -z "$name" ]]; then
        error "Profile name required"
        echo "Usage: lucid-profile-mgr create <name> [aging_days] [template]"
        exit 1
    fi
    
    local profile_dir="$PROFILES_DIR/$name"
    
    if [[ -d "$profile_dir" ]]; then
        error "Profile '$name' already exists"
        exit 1
    fi
    
    log "Creating profile: $name (aging: ${aging} days)"
    
    mkdir -p "$profile_dir"/{browser,data}
    
    local profile_id=$(generate_uuid)
    local created=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local seed=$(echo -n "$profile_id" | md5sum | cut -d' ' -f1)
    
    # Load template if exists
    local template_file="$TEMPLATES_DIR/${template}.json"
    if [[ -f "$template_file" ]]; then
        log "Using template: $template"
        cp "$template_file" "$profile_dir/template.json"
    fi
    
    # Generate profile.json
    cat > "$profile_dir/profile.json" << EOF
{
    "profile_name": "$name",
    "profile_id": "$profile_id",
    "created": "$created",
    "aging_days": $aging,
    "fingerprint_seed": "$seed",
    "template": "$template",
    "persona": {
        "name": "",
        "email": "",
        "phone": "",
        "address": ""
    },
    "location": {
        "city": "",
        "country": "US",
        "timezone": "America/New_York",
        "locale": "en-US",
        "latitude": 40.7128,
        "longitude": -74.0060
    },
    "browser": {
        "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
        "platform": "Win32",
        "resolution": {"width": 1920, "height": 1080},
        "color_depth": 24,
        "device_memory": 8,
        "hardware_concurrency": 8
    },
    "fingerprints": {
        "canvas_seed": "${seed:0:16}",
        "webgl_seed": "${seed:16:16}",
        "audio_seed": "${seed:8:16}",
        "font_seed": "${seed:4:16}"
    },
    "network": {
        "tcp_profile": "windows",
        "proxy": null
    },
    "status": "created"
}
EOF
    
    # Calculate time offset for aging
    local offset_seconds=$((aging * 86400))
    local backdated=$(date -u -d "-${aging} days" +%Y-%m-%dT%H:%M:%SZ)
    echo "-${aging}d" > "$profile_dir/time_offset"
    
    log "Profile created: $profile_dir"
    log "Profile ID: $profile_id"
    log "Backdated to: $backdated"
    
    echo ""
    echo -e "${CYAN}Next steps:${NC}"
    echo "  1. Edit profile.json to customize persona details"
    echo "  2. Load profile: lucid-profile-mgr load $name"
    echo "  3. Launch browser: lucid-browser"
}

# Load profile
cmd_load() {
    local name="$1"
    
    if [[ -z "$name" ]]; then
        error "Profile name required"
        exit 1
    fi
    
    local profile_dir="$PROFILES_DIR/$name"
    
    if [[ ! -d "$profile_dir" ]]; then
        error "Profile not found: $name"
        exit 1
    fi
    
    log "Loading profile: $name"
    
    # Clear active profile
    rm -rf "$ACTIVE_DIR"/*
    
    # Copy profile to active
    cp -r "$profile_dir"/* "$ACTIVE_DIR/"
    
    # Read profile data
    local profile_json="$ACTIVE_DIR/profile.json"
    local aging=$(jq -r '.aging_days // 90' "$profile_json")
    local tcp_profile=$(jq -r '.network.tcp_profile // "windows"' "$profile_json")
    local timezone=$(jq -r '.location.timezone // "UTC"' "$profile_json")
    
    # Set time offset
    echo "-${aging}d" > "$ACTIVE_DIR/time_offset"
    
    # Configure eBPF if root
    if [[ $EUID -eq 0 ]]; then
        if [[ -x "$TITAN_HOME/bin/load-ebpf.sh" ]]; then
            log "Configuring TCP fingerprint: $tcp_profile"
            "$TITAN_HOME/bin/load-ebpf.sh" "" "$tcp_profile" load 2>/dev/null || \
                warn "eBPF configuration failed (may need kernel support)"
        fi
    else
        warn "Run as root to enable eBPF TCP masquerade"
    fi
    
    # Update status
    jq '.status = "active"' "$profile_json" > "$profile_json.tmp" && \
        mv "$profile_json.tmp" "$profile_json"
    
    log "Profile loaded successfully"
    log "Time offset: -${aging} days"
    log "TCP Profile: $tcp_profile"
    log "Timezone: $timezone"
    
    echo ""
    echo -e "${GREEN}Profile '$name' is now active${NC}"
    echo "Launch browser with: lucid-browser"
}

# List profiles
cmd_list() {
    print_banner
    
    echo -e "${CYAN}Available Profiles:${NC}"
    echo "─────────────────────────────────────────────────────────────"
    printf "%-20s %-12s %-10s %s\n" "NAME" "AGE (days)" "STATUS" "CREATED"
    echo "─────────────────────────────────────────────────────────────"
    
    local count=0
    for dir in "$PROFILES_DIR"/*/; do
        [[ ! -d "$dir" ]] && continue
        [[ "$(basename "$dir")" == "active" ]] && continue
        [[ "$(basename "$dir")" == "burned" ]] && continue
        
        local name=$(basename "$dir")
        local profile_json="$dir/profile.json"
        
        if [[ -f "$profile_json" ]]; then
            local aging=$(jq -r '.aging_days // "?"' "$profile_json")
            local created=$(jq -r '.created // "?"' "$profile_json" | cut -dT -f1)
            local status=$(jq -r '.status // "created"' "$profile_json")
            
            # Check if active
            if [[ -f "$ACTIVE_DIR/profile.json" ]]; then
                local active_name=$(jq -r '.profile_name' "$ACTIVE_DIR/profile.json")
                [[ "$active_name" == "$name" ]] && status="ACTIVE"
            fi
            
            printf "%-20s %-12s %-10s %s\n" "$name" "$aging" "$status" "$created"
            ((count++))
        fi
    done
    
    echo "─────────────────────────────────────────────────────────────"
    echo "Total: $count profiles"
    
    # Show active profile
    if [[ -f "$ACTIVE_DIR/profile.json" ]]; then
        echo ""
        local active_name=$(jq -r '.profile_name' "$ACTIVE_DIR/profile.json")
        echo -e "${GREEN}Active Profile:${NC} $active_name"
    fi
}

# Show profile details
cmd_show() {
    local name="$1"
    local profile_dir
    
    if [[ -z "$name" ]] || [[ "$name" == "active" ]]; then
        profile_dir="$ACTIVE_DIR"
        if [[ ! -f "$profile_dir/profile.json" ]]; then
            error "No active profile"
            exit 1
        fi
    else
        profile_dir="$PROFILES_DIR/$name"
        if [[ ! -d "$profile_dir" ]]; then
            error "Profile not found: $name"
            exit 1
        fi
    fi
    
    local profile_json="$profile_dir/profile.json"
    
    echo -e "${CYAN}Profile Details:${NC}"
    echo "─────────────────────────────────────────────────────────────"
    jq '.' "$profile_json"
}

# Burn profile
cmd_burn() {
    local confirm="${1:-}"
    
    if [[ ! -f "$ACTIVE_DIR/profile.json" ]]; then
        error "No active profile to burn"
        exit 1
    fi
    
    local name=$(jq -r '.profile_name' "$ACTIVE_DIR/profile.json")
    
    if [[ "$confirm" != "-y" ]] && [[ "$confirm" != "--yes" ]]; then
        echo -e "${RED}⚠️  WARNING: BURN PROFILE${NC}"
        echo ""
        echo "This will archive and wipe the active profile: $name"
        echo "This action cannot be undone."
        echo ""
        read -p "Type 'yes' to confirm: " response
        if [[ "$response" != "yes" ]]; then
            echo "Aborted."
            exit 0
        fi
    fi
    
    log "Burning profile: $name"
    
    # Archive to burned directory
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local archive_dir="$BURNED_DIR/${name}_${timestamp}"
    
    mkdir -p "$archive_dir"
    cp -r "$ACTIVE_DIR"/* "$archive_dir/" 2>/dev/null || true
    
    # Update status
    jq '.status = "burned" | .burned_at = now' "$archive_dir/profile.json" > "$archive_dir/profile.json.tmp" && \
        mv "$archive_dir/profile.json.tmp" "$archive_dir/profile.json" 2>/dev/null || true
    
    # Wipe active profile
    rm -rf "$ACTIVE_DIR"/*
    mkdir -p "$ACTIVE_DIR"
    
    # Unload eBPF
    if [[ $EUID -eq 0 ]] && [[ -x "$TITAN_HOME/bin/load-ebpf.sh" ]]; then
        "$TITAN_HOME/bin/load-ebpf.sh" "" "" unload 2>/dev/null || true
    fi
    
    log "Profile burned and archived to: $archive_dir"
    echo ""
    echo -e "${GREEN}Profile '$name' has been burned${NC}"
    echo "Ready for new identity."
}

# Delete profile permanently
cmd_delete() {
    local name="$1"
    
    if [[ -z "$name" ]]; then
        error "Profile name required"
        exit 1
    fi
    
    local profile_dir="$PROFILES_DIR/$name"
    
    if [[ ! -d "$profile_dir" ]]; then
        error "Profile not found: $name"
        exit 1
    fi
    
    echo -e "${RED}⚠️  PERMANENT DELETE${NC}"
    echo "Delete profile '$name' permanently?"
    read -p "Type profile name to confirm: " response
    
    if [[ "$response" == "$name" ]]; then
        rm -rf "$profile_dir"
        log "Profile deleted: $name"
    else
        echo "Aborted."
    fi
}

# Export profile
cmd_export() {
    local name="$1"
    local output="${2:-${name}.tar.gz}"
    
    if [[ -z "$name" ]]; then
        error "Profile name required"
        exit 1
    fi
    
    local profile_dir="$PROFILES_DIR/$name"
    
    if [[ ! -d "$profile_dir" ]]; then
        error "Profile not found: $name"
        exit 1
    fi
    
    log "Exporting profile: $name -> $output"
    tar -czf "$output" -C "$PROFILES_DIR" "$name"
    log "Exported to: $output"
}

# Import profile
cmd_import() {
    local archive="$1"
    
    if [[ -z "$archive" ]] || [[ ! -f "$archive" ]]; then
        error "Archive file required"
        exit 1
    fi
    
    log "Importing profile from: $archive"
    tar -xzf "$archive" -C "$PROFILES_DIR"
    log "Profile imported"
}

# Main
init_dirs

case "${1:-}" in
    create)
        cmd_create "$2" "$3" "$4"
        ;;
    load)
        cmd_load "$2"
        ;;
    list|ls)
        cmd_list
        ;;
    show|info)
        cmd_show "$2"
        ;;
    burn)
        cmd_burn "$2"
        ;;
    delete|rm)
        cmd_delete "$2"
        ;;
    export)
        cmd_export "$2" "$3"
        ;;
    import)
        cmd_import "$2"
        ;;
    *)
        print_banner
        echo "Usage: lucid-profile-mgr <command> [options]"
        echo ""
        echo "Commands:"
        echo "  create <name> [aging] [template]  Create new profile"
        echo "  load <name>                       Load profile as active"
        echo "  list                              List all profiles"
        echo "  show [name|active]                Show profile details"
        echo "  burn [-y]                         Burn active profile"
        echo "  delete <name>                     Permanently delete profile"
        echo "  export <name> [file]              Export profile to archive"
        echo "  import <file>                     Import profile from archive"
        echo ""
        echo "Examples:"
        echo "  lucid-profile-mgr create merchant_01 90 us_ecom_premium"
        echo "  lucid-profile-mgr load merchant_01"
        echo "  lucid-profile-mgr burn -y"
        ;;
esac
