"use strict";var QWebChannel=function(transport,initCallback){if(typeof transport!=="object"||typeof transport.send!=="function"){console.error("The QWebChannel expects a transport object with a send function and onmessage callback property.",transport);return}var channel=this;this.transport=transport;this.send=function(data){if(typeof data!=="string"){data=JSON.stringify(data)}channel.transport.send(data)};this.transport.onmessage=function(message){var data=message.data;if(typeof data==="string"){data=JSON.parse(data)}switch(data.type){case QWebChannel.qtWebChannelSignalType:channel.handleSignal(data);break;case QWebChannel.qtWebChannelResponseType:channel.handleResponse(data);break;case QWebChannel.qtWebChannelPropertyUpdateType:channel.handlePropertyUpdate(data);break;default:console.error("invalid message received:",message.data);break}};this.execCallbacks={};this.execId=0;this.exec=function(data,callback){if(!callback){channel.send(data);return}var execId=channel.execId++;data.id=execId;channel.execCallbacks[execId]=callback;channel.send(data)};this.objects={};this.handleSignal=function(message){var object=channel.objects[message.object];if(object){object.signalEmitted(message.signal,message.args)}else{console.warn("Unhandled signal: "+message.object+"::"+message.signal)}};this.handleResponse=function(message){if(!message.hasOwnProperty("id")){console.error("Invalid response message received: ",message);return}channel.execCallbacks[message.id](message.data);delete channel.execCallbacks[message.id]};this.handlePropertyUpdate=function(message){for(var i in message.data){var data=message.data[i];var object=channel.objects[data.object];if(object){object.propertyUpdate(data.signals,data.properties)}else{console.warn("Unhandled property update: "+data.object+"::"+data.signal)}};channel.execCallbacks[message.id](message.data);delete channel.execCallbacks[message.id]};this.debug=function(message){channel.send({type:QWebChannel.qtWebChannelDebugType,data:message})};channel.exec({type:QWebChannel.qtWebChannelInitType},function(data){for(var objectName in data){var object=new QObject(objectName,data[objectName],channel);channel.objects[objectName]=object}if(initCallback){initCallback(channel)}})};QWebChannel.qtWebChannelInitType=0;QWebChannel.qtWebChannelSignalType=1;QWebChannel.qtWebChannelPropertyUpdateType=2;QWebChannel.qtWebChannelDebugType=3;QWebChannel.qtWebChannelResponseType=10;var QObject=function(name,data,webChannel){this.__id__=name;this.__objectSignals__={};this.__propertyCache__={};var object=this;this.unwrapQObject=function(response){if(response instanceof Array){var ret=new Array(response.length);for(var i=0;i<response.length;++i){ret[i]=object.unwrapQObject(response[i])}return ret}if(!response||!response["__QObject*__"]||response.id===undefined){return response}var objectId=response.id;if(webChannel.objects[objectId]){return webChannel.objects[objectId]}if(!response.data){console.error("Cannot unwrap unknown QObject "+objectId+" without data.");return null}var qObject=new QObject(objectId,response.data,webChannel);qObject.destroyed.connect(function(){if(webChannel.objects[objectId]===qObject){delete webChannel.objects[objectId]}});webChannel.objects[objectId]=qObject;return qObject};this.unwrapProperties=function(properties){for(var propertyIdx in properties){object.__propertyCache__[propertyIdx]=object.unwrapQObject(properties[propertyIdx])}};function addSignal(signalData,isPropertyNotifySignal){var signalName=signalData[0];var signalIndex=signalData[1];object[signalName]={connect:function(callback){if(typeof callback!=="function"){console.error("Bad callback given to connect to signal "+signalName);return}object.__objectSignals__[signalIndex]=object.__objectSignals__[signalIndex]||[];object.__objectSignals__[signalIndex].push(callback);if(!isPropertyNotifySignal&&signalName!=="destroyed"){webChannel.exec({type:QWebChannel.qtWebChannelDebugType,data:"connect to signal "+name+"::"+signalName})}},disconnect:function(callback){if(typeof callback!=="function"){console.error("Bad callback given to disconnect from signal "+signalName);return}object.__objectSignals__[signalIndex]=object.__objectSignals__[signalIndex]||[];var idx=object.__objectSignals__[signalIndex].indexOf(callback);if(idx===-1){console.error("Cannot find connection of signal "+signalName+" to "+callback.name);return}object.__objectSignals__[signalIndex].splice(idx,1);if(!isPropertyNotifySignal&&signalName!=="destroyed"){webChannel.exec({type:QWebChannel.qtWebChannelDebugType,data:"disconnect from signal "+name+"::"+signalName})}}};}function addProperty(propertyData){var propertyName=propertyData[0];var propertySignal=propertyData[1];var propertyValue=propertyData[2];if(propertySignal){addSignal(propertySignal,true)}object[propertyName]=propertyValue;object.__propertyCache__[propertyName]=propertyValue;if(propertyValue){object[propertyName]=object.unwrapQObject(propertyValue)}Object.defineProperty(object,propertyName,{configurable:true,get:function(){var propertyValue=object.__propertyCache__[propertyName];if(propertyValue===undefined){webChannel.exec({type:QWebChannel.qtWebChannelDebugType,data:"Property "+propertyName+" of object "+name+" accessed but no cached value. This should not happen!"});return}return propertyValue},set:function(value){if(value===undefined){console.warn("Property setter for "+propertyName+" called with undefined value!");return}object.__propertyCache__[propertyName]=value;webChannel.exec({type:QWebChannel.qtWebChannelPropertyUpdateType,data:[{object:name,properties:{[propertyName]:value}}]})}})}function addMethod(methodData){var methodName=methodData[0];var methodReturnType=methodData[1];object[methodName]=function(){var args=[];var callback;for(var i=0;i<arguments.length;++i){var arg=arguments[i];if(typeof arg==="function"){callback=arg}else{args.push(arg)}}webChannel.exec({type:QWebChannel.qtWebChannelResponseType,object:name,method:methodName,args:args},function(response){if(response!==undefined){var result=object.unwrapQObject(response);if(callback){(callback)(result)}}})}}this.propertyUpdate=function(signals,properties){this.unwrapProperties(properties);for(var signalName in signals){var signal=this.__objectSignals__[signalName];if(signal){var signalArgs=this.unwrapQObject(signals[signalName]);for(var i=0;i<signal.length;++i){signal[i].apply(signal,signalArgs)}}}};this.signalEmitted=function(signalName,signalArgs){var signal=this.__objectSignals__[signalName];if(signal){signalArgs=this.unwrapQObject(signalArgs);for(var i=0;i<signal.length;++i){signal[i].apply(signal,signalArgs)}}};addSignal(["destroyed",-1]);for(var i in data.methods){addMethod(data.methods[i])}for(var i in data.properties){addProperty(data.properties[i])}for(var i in data.signals){addSignal(data.signals[i],false)}this.unwrapProperties(data.properties)};
