"""
TITAN V7.6 SINGULARITY â€” AI Checkout Co-Pilot
Passive AI assistant that silently helps the human operator during checkout.

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ARCHITECTURE: HUMAN OPERATES, AI SILENTLY ASSISTS                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                              â•‘
â•‘  The human operator manually browses, selects products, fills forms.         â•‘
â•‘  The AI co-pilot runs INVISIBLY in the background and:                       â•‘
â•‘                                                                              â•‘
â•‘  1. DETECTS when the human reaches a checkout/payment page                   â•‘
â•‘  2. BLOCKS 3DS Method fingerprint iframes before they load (<10ms)           â•‘
â•‘  3. INTERCEPTS 3DS challenge signals and applies countermeasures             â•‘
â•‘  4. OPTIMIZES device data sent to ACS for frictionless approval              â•‘
â•‘  5. MONITORS all network requests for decline/fraud signals                  â•‘
â•‘  6. ALERTS the operator via subtle UI overlay if action needed               â•‘
â•‘  7. RETRIES soft declines instantly within the PSP retry window              â•‘
â•‘                                                                              â•‘
â•‘  The human never needs to know the AI is there. They just experience         â•‘
â•‘  smoother checkouts with fewer 3DS challenges and fewer declines.            â•‘
â•‘                                                                              â•‘
â•‘  DELIVERY: Browser extension content script injected into Camoufox           â•‘
â•‘  at launch via integration_bridge.py â†’ loaded as extension.                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   HUMAN OPERATOR                      â”‚
    â”‚         (browses, clicks, types normally)              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ uses
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              CAMOUFOX BROWSER                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  AI Co-Pilot Content Script (this module's JS)  â”‚  â”‚
    â”‚  â”‚  â”€ Runs on every page silently                  â”‚  â”‚
    â”‚  â”‚  â”€ Activates ONLY on checkout/payment pages     â”‚  â”‚
    â”‚  â”‚  â”€ Blocks 3DS iframes in <10ms                  â”‚  â”‚
    â”‚  â”‚  â”€ Monitors network for 3DS signals             â”‚  â”‚
    â”‚  â”‚  â”€ Shows subtle status overlay to operator      â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  Ghost Motor (existing extension)               â”‚  â”‚
    â”‚  â”‚  â”€ Human-like mouse/keyboard augmentation       â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usage:
    from titan_3ds_ai_exploits import get_3ds_ai_engine

    engine = get_3ds_ai_engine()

    # Get the content script to inject into Camoufox
    script = engine.get_copilot_script()

    # Get the extension manifest for Camoufox loading
    manifest = engine.get_extension_manifest()

    # Get optimal co-pilot config for a specific target + card
    config = engine.get_copilot_config(psp="stripe", card_country="US", amount=50)
"""

import json
import os
import logging
import threading
from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional
from enum import Enum
from pathlib import Path

__version__ = "8.0.0"
__author__ = "Dva.12"

logger = logging.getLogger("TITAN-AI-COPILOT")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CO-PILOT STATE MACHINE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# The co-pilot has states that track what the human operator is doing.
# It only activates interventions when it detects a checkout/payment context.
# On normal browsing pages, it is completely dormant â€” zero overhead.

class CopilotState(Enum):
    DORMANT = "dormant"              # Normal browsing â€” co-pilot is sleeping
    WATCHING = "watching"            # Detected e-commerce site â€” monitoring
    CHECKOUT_DETECTED = "checkout"   # Human is on a checkout/payment page
    PAYMENT_ACTIVE = "payment"       # Payment form detected â€” shields up
    THREE_DS_INCOMING = "3ds"        # 3DS signals detected â€” intervening
    COMPLETE = "complete"            # Transaction finished â€” logging result


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# THE CONTENT SCRIPT â€” This is the JavaScript that runs inside Camoufox
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# This is a SINGLE content script that:
# 1. Runs on every page the human visits
# 2. Detects checkout/payment context via URL and DOM analysis
# 3. When checkout detected: activates all silent protections
# 4. Shows a tiny, non-intrusive status indicator to the operator
#
# The human operator sees: a small shield icon in the corner.
#   ğŸ›¡ï¸ Gray   = dormant (normal browsing)
#   ğŸ›¡ï¸ Blue   = watching (e-commerce site detected)
#   ğŸ›¡ï¸ Green  = active (checkout page, shields up)
#   ğŸ›¡ï¸ Yellow = 3DS detected (intervening)
#   ğŸ›¡ï¸ Red    = decline/block detected

COPILOT_CONTENT_SCRIPT = r"""
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TITAN AI CHECKOUT CO-PILOT v7.6
// Passive assistant â€” activates only when human reaches checkout
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
    'use strict';

    // â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let state = 'dormant';
    let detectedPSP = null;
    let threeDSBlocked = 0;
    let signalsDetected = [];
    let overlayEl = null;

    // â”€â”€â”€ CHECKOUT PAGE DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Detect if the human has navigated to a checkout/payment page.
    // This uses URL patterns + DOM element detection.
    // The co-pilot does NOTHING until this triggers.

    const CHECKOUT_URL_PATTERNS = [
        /checkout/i, /payment/i, /pay\b/i, /billing/i, /order/i,
        /cart.*confirm/i, /purchase/i, /subscribe/i, /donate/i,
        /\/pay$/i, /\/checkout$/i, /secure.*pay/i,
    ];

    const CHECKOUT_DOM_SELECTORS = [
        'input[name*="card"]', 'input[name*="cc-"]', 'input[autocomplete="cc-number"]',
        'input[data-elements-stable-field-name="cardNumber"]',  // Stripe Elements
        '[class*="CardNumberField"]', '[class*="card-number"]',
        '#card-number', '#cardNumber', '#credit-card-number',
        '.adyen-checkout__card', '.braintree-hosted-field',     // Adyen / Braintree
        '[data-braintree-id]', '.sq-card-component',            // Square
        'iframe[name*="__privateStripeFrame"]',                  // Stripe iframe
        'iframe[src*="js.stripe.com"]',
        'iframe[src*="checkoutshopper"]',                        // Adyen hosted
    ];

    const PSP_DETECTION_PATTERNS = {
        stripe:           [/js\.stripe\.com/i, /stripe.*elements/i, /__stripe_mid/i, /pk_live_/i, /pk_test_/i],
        adyen:            [/adyen\.com/i, /adyen-checkout/i, /checkoutshopper/i],
        braintree:        [/braintreegateway/i, /braintree-api/i, /client\.braintreegateway/i],
        shopify_payments: [/cdn\.shopify\.com.*payment/i, /pay\.shopify\.com/i, /shopify.*checkout/i],
        worldpay:         [/worldpay/i, /secure\.worldpay/i],
        checkout_com:     [/checkout\.com/i, /cdn\.checkout\.com/i],
        square:           [/squareup\.com/i, /js\.squareup\.com/i, /sq-payment/i],
        authorize_net:    [/authorize\.net/i, /accept\.authorize/i, /acceptjs/i],
        paypal:           [/paypal\.com\/sdk/i, /paypalobjects\.com/i],
    };

    // â”€â”€â”€ 3DS SIGNAL PATTERNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Known ACS (Access Control Server) domains that serve 3DS challenges
    const ACS_DOMAINS = [
        'cardinalcommerce.com', 'arcot.com', 'centinelapistag.com',
        'centinelapi.com', 'songbird', '3dsecure', 'threedsecure',
        'acs.', 'verifiedbyvisa.com', 'securecode.com',
        'mastercard.com/gateway', 'visa.com/3ds',
    ];

    // Signals in API responses that indicate 3DS is being triggered
    const RESPONSE_3DS_SIGNALS = [
        'threeDSMethodURL', 'acsURL', 'acsChallengeMandated',
        'requires_action', 'RedirectShopper', 'threeds2.fingerprint',
        'threeds2.challenge', 'challengeIndicator', 'DDCUrl',
    ];

    // â”€â”€â”€ PHASE 1: PAGE CONTEXT DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Runs once on every page load. Determines if this is a checkout page.
    // If not, the co-pilot stays dormant â€” zero overhead.

    function detectPageContext() {
        const url = window.location.href.toLowerCase();
        const isCheckoutURL = CHECKOUT_URL_PATTERNS.some(p => p.test(url));

        if (isCheckoutURL) {
            transitionTo('checkout');
            return;
        }

        // Check DOM for payment form elements (delayed â€” wait for page render)
        setTimeout(function() {
            for (const sel of CHECKOUT_DOM_SELECTORS) {
                if (document.querySelector(sel)) {
                    transitionTo('checkout');
                    return;
                }
            }
            // Not a checkout page â€” check if it's at least an e-commerce site
            if (detectEcommerceSite()) {
                transitionTo('watching');
            }
        }, 1500);
    }

    function detectEcommerceSite() {
        const html = document.documentElement.innerHTML.substring(0, 50000).toLowerCase();
        const signals = ['add to cart', 'add-to-cart', 'addtocart', 'buy now',
                         'shop now', 'checkout', 'shopping cart', 'product-price',
                         'shopify', 'woocommerce', 'bigcommerce', 'magento'];
        return signals.some(s => html.includes(s));
    }

    // â”€â”€â”€ PHASE 2: PSP DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // When checkout is detected, identify which PSP the merchant uses.
    // This determines which specific protections to activate.

    function detectPSP() {
        const html = document.documentElement.innerHTML.substring(0, 100000);
        const scripts = Array.from(document.querySelectorAll('script[src]'))
            .map(s => s.src.toLowerCase());
        const iframes = Array.from(document.querySelectorAll('iframe[src]'))
            .map(f => f.src.toLowerCase());
        const allSources = scripts.concat(iframes).concat([html.toLowerCase()]);
        const combined = allSources.join(' ');

        for (const [psp, patterns] of Object.entries(PSP_DETECTION_PATTERNS)) {
            if (patterns.some(p => p.test(combined))) {
                detectedPSP = psp;
                updateOverlay();
                return psp;
            }
        }
        return null;
    }

    // â”€â”€â”€ PHASE 3: SILENT PROTECTIONS (activate on checkout) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // These run INVISIBLY while the human fills out the payment form.

    // PROTECTION A: Block 3DS Method iframes
    // The 3DS 2.0 spec requires a hidden iframe to fingerprint the device.
    // We block it before it loads. The ACS gets no device data â†’ higher
    // chance of frictionless approval or 1.0 fallback.
    // EMV Spec Â§5.3.4: threeDSCompInd='U' when Method unavailable.

    function activateIframeShield() {
        const observer = new MutationObserver(function(mutations) {
            for (const mutation of mutations) {
                for (const node of mutation.addedNodes) {
                    if (!node.tagName) continue;
                    if (node.tagName === 'IFRAME') {
                        if (is3DSIframe(node)) {
                            neutralizeIframe(node);
                        }
                    }
                    // Also check children of added nodes
                    if (node.querySelectorAll) {
                        node.querySelectorAll('iframe').forEach(function(iframe) {
                            if (is3DSIframe(iframe)) {
                                neutralizeIframe(iframe);
                            }
                        });
                    }
                }
            }
        });

        observer.observe(document.documentElement, {
            childList: true,
            subtree: true
        });
    }

    function is3DSIframe(iframe) {
        const src = (iframe.src || iframe.getAttribute('data-src') || '').toLowerCase();
        const name = (iframe.name || '').toLowerCase();
        const id = (iframe.id || '').toLowerCase();

        // Match against known ACS domains
        if (ACS_DOMAINS.some(function(d) { return src.includes(d); })) return true;

        // Match against 3DS-specific naming
        if (/threeds|3ds|cardinal|songbird|ddc/i.test(name + id)) return true;

        // Hidden iframes with ACS-like sources (0x0 or display:none)
        const isHidden = (iframe.width === '0' || iframe.height === '0' ||
                          iframe.style.width === '0px' || iframe.style.height === '0px' ||
                          iframe.style.display === 'none' || iframe.hidden);
        if (isHidden && src && src !== 'about:blank' && !src.startsWith('javascript:')) {
            // Hidden iframe with external src during checkout = likely 3DS Method
            if (ACS_DOMAINS.some(function(d) { return src.includes(d); })) return true;
        }

        return false;
    }

    function neutralizeIframe(iframe) {
        // Don't remove â€” some PSPs check for existence. Just neutralize.
        iframe.src = 'about:blank';
        iframe.removeAttribute('data-src');
        threeDSBlocked++;
        updateOverlay();
    }

    // PROTECTION B: Network request monitoring
    // Intercept fetch() and XHR to detect 3DS signals in API responses.
    // When detected, log them and alert the operator.

    function activateNetworkMonitor() {
        // Intercept fetch()
        const origFetch = window.fetch;
        window.fetch = async function() {
            const response = await origFetch.apply(this, arguments);

            if (state === 'checkout' || state === 'payment' || state === '3ds') {
                try {
                    const clone = response.clone();
                    const text = await clone.text();
                    scanForSignals(text, 'fetch');
                } catch(e) { /* binary response or CORS â€” ignore */ }
            }

            return response;
        };

        // Intercept XHR
        const origOpen = XMLHttpRequest.prototype.open;
        const origSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function(method, url) {
            this._titanUrl = url;
            return origOpen.apply(this, arguments);
        };

        XMLHttpRequest.prototype.send = function() {
            const xhr = this;
            xhr.addEventListener('load', function() {
                if (state === 'checkout' || state === 'payment' || state === '3ds') {
                    try {
                        scanForSignals(xhr.responseText || '', 'xhr');
                    } catch(e) {}
                }
            });
            return origSend.apply(this, arguments);
        };
    }

    function scanForSignals(text, source) {
        if (!text || text.length < 10) return;

        for (const signal of RESPONSE_3DS_SIGNALS) {
            if (text.includes(signal)) {
                signalsDetected.push({
                    signal: signal,
                    source: source,
                    time: Date.now(),
                });
                transitionTo('3ds');
            }
        }

        // Detect decline signals
        const declinePatterns = [
            'card_declined', 'insufficient_funds', 'do_not_honor',
            'fraudulent', 'pickup_card', 'restricted_card',
            'transaction_not_allowed', 'generic_decline',
        ];
        for (const pattern of declinePatterns) {
            if (text.toLowerCase().includes(pattern)) {
                showOperatorAlert('decline', 'Transaction declined: ' + pattern);
            }
        }

        // Detect success
        if (text.includes('"succeeded"') || text.includes('"Authorised"') ||
            text.includes('"approved"') || text.includes('"APPROVED"') ||
            text.includes('"paid":true')) {
            transitionTo('complete');
            showOperatorAlert('success', 'Payment approved');
        }
    }

    // PROTECTION C: Payment form detection
    // When the human starts interacting with a card input field,
    // transition to PAYMENT_ACTIVE state for maximum protection.

    function activateFormMonitor() {
        document.addEventListener('focus', function(e) {
            const el = e.target;
            if (!el || !el.tagName) return;
            const tag = el.tagName.toLowerCase();
            if (tag !== 'input' && tag !== 'select') return;

            const name = (el.name || '').toLowerCase();
            const auto = (el.autocomplete || '').toLowerCase();
            const id = (el.id || '').toLowerCase();
            const combined = name + ' ' + auto + ' ' + id;

            if (/card|cc-number|ccnumber|creditcard/i.test(combined)) {
                transitionTo('payment');
            }
        }, true);
    }

    // â”€â”€â”€ CO-PILOT â†’ OS REPORTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Send state updates to the local Titan API so the Python-side
    // Operations Guard can receive real-time browser intelligence.
    // Uses navigator.sendBeacon for fire-and-forget reliability.

    function reportToOS(eventType, data) {
        try {
            var payload = JSON.stringify({
                event: eventType,
                state: state,
                psp: detectedPSP,
                url: window.location.hostname,
                threeDSBlocked: threeDSBlocked,
                signals: signalsDetected.slice(-5),
                timestamp: Date.now(),
                data: data || {},
            });
            // Try local Titan API (cockpit daemon)
            if (navigator.sendBeacon) {
                navigator.sendBeacon('http://127.0.0.1:8443/api/copilot/event', payload);
            }
        } catch(e) { /* silent â€” OS comms are best-effort */ }
    }

    // â”€â”€â”€ STATE TRANSITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function transitionTo(newState) {
        if (newState === state) return;
        var oldState = state;
        state = newState;

        // Report every state transition to OS
        reportToOS('state_change', { from: oldState, to: newState });

        switch (newState) {
            case 'watching':
                // E-commerce site detected â€” light monitoring
                break;

            case 'checkout':
                // Checkout page! Activate all protections
                detectPSP();
                activateIframeShield();
                activateNetworkMonitor();
                activateFormMonitor();
                reportToOS('checkout_detected', { psp: detectedPSP });
                break;

            case 'payment':
                // Human is entering card details â€” maximum alertness
                reportToOS('payment_active', {});
                break;

            case '3ds':
                // 3DS signals detected â€” show warning to operator
                showOperatorAlert('3ds',
                    '3DS challenge detected' +
                    (threeDSBlocked > 0 ? ' (' + threeDSBlocked + ' blocked)' : '')
                );
                reportToOS('3ds_detected', { blocked: threeDSBlocked, signals: signalsDetected });
                break;

            case 'complete':
                // Transaction finished
                reportToOS('transaction_complete', { blocked: threeDSBlocked });
                break;
        }

        updateOverlay();
    }

    // â”€â”€â”€ OPERATOR UI OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // A tiny, non-intrusive shield icon in the bottom-right corner.
    // The operator can glance at it to see co-pilot status.
    // It does NOT interfere with any page elements or checkout flow.

    const STATE_COLORS = {
        dormant:  { bg: '#555', icon: 'ğŸ›¡ï¸', label: '' },
        watching: { bg: '#2196F3', icon: 'ğŸ›¡ï¸', label: 'Watching' },
        checkout: { bg: '#4CAF50', icon: 'ğŸ›¡ï¸', label: 'Active' },
        payment:  { bg: '#4CAF50', icon: 'ğŸ›¡ï¸', label: 'Shields Up' },
        '3ds':    { bg: '#FF9800', icon: 'âš ï¸', label: '3DS' },
        complete: { bg: '#4CAF50', icon: 'âœ…', label: 'Done' },
    };

    function createOverlay() {
        if (overlayEl) return;
        overlayEl = document.createElement('div');
        overlayEl.id = 'titan-copilot-overlay';
        overlayEl.style.cssText =
            'position:fixed;bottom:8px;right:8px;z-index:2147483647;' +
            'padding:4px 10px;border-radius:12px;font-size:11px;' +
            'font-family:-apple-system,BlinkMacSystemFont,sans-serif;' +
            'color:#fff;cursor:default;user-select:none;opacity:0.7;' +
            'transition:all 0.3s ease;pointer-events:none;' +
            'backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);';
        document.documentElement.appendChild(overlayEl);
    }

    function updateOverlay() {
        if (!overlayEl) createOverlay();
        const s = STATE_COLORS[state] || STATE_COLORS.dormant;
        overlayEl.style.background = s.bg;
        let text = s.icon;
        if (s.label) text += ' ' + s.label;
        if (detectedPSP && state !== 'dormant') {
            text += ' Â· ' + detectedPSP;
        }
        if (threeDSBlocked > 0) {
            text += ' Â· ' + threeDSBlocked + ' blocked';
        }
        overlayEl.textContent = text;

        // Pulse on state change
        overlayEl.style.opacity = '1';
        setTimeout(function() { if (overlayEl) overlayEl.style.opacity = '0.7'; }, 2000);
    }

    // â”€â”€â”€ OPERATOR ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Brief, non-blocking notifications that appear and auto-dismiss.
    // These tell the operator what's happening without interrupting them.

    function showOperatorAlert(type, message) {
        const colors = {
            '3ds':     { bg: '#FF9800', text: '#000' },
            decline:   { bg: '#f44336', text: '#fff' },
            success:   { bg: '#4CAF50', text: '#fff' },
            info:      { bg: '#2196F3', text: '#fff' },
        };
        const c = colors[type] || colors.info;

        const alert = document.createElement('div');
        alert.style.cssText =
            'position:fixed;top:12px;right:12px;z-index:2147483647;' +
            'padding:10px 18px;border-radius:8px;font-size:13px;' +
            'font-family:-apple-system,BlinkMacSystemFont,sans-serif;' +
            'color:' + c.text + ';background:' + c.bg + ';' +
            'box-shadow:0 4px 12px rgba(0,0,0,0.3);' +
            'opacity:0;transform:translateY(-10px);' +
            'transition:all 0.3s ease;pointer-events:none;';
        alert.textContent = message;
        document.documentElement.appendChild(alert);

        // Animate in
        requestAnimationFrame(function() {
            alert.style.opacity = '1';
            alert.style.transform = 'translateY(0)';
        });

        // Auto-dismiss after 4 seconds
        setTimeout(function() {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(function() { alert.remove(); }, 300);
        }, 4000);
    }

    // â”€â”€â”€ INITIALIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Start the co-pilot. It begins in DORMANT state and only activates
    // when it detects the human is on a checkout page.

    function init() {
        createOverlay();
        detectPageContext();

        // Re-check on SPA navigation (pushState/popState)
        const origPush = history.pushState;
        history.pushState = function() {
            origPush.apply(this, arguments);
            setTimeout(function() {
                state = 'dormant';
                detectedPSP = null;
                threeDSBlocked = 0;
                signalsDetected = [];
                detectPageContext();
            }, 500);
        };
        window.addEventListener('popstate', function() {
            setTimeout(function() {
                state = 'dormant';
                detectPageContext();
            }, 500);
        });
    }

    // Wait for DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXTENSION MANIFEST â€” For loading as a Camoufox web extension
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EXTENSION_MANIFEST = {
    "manifest_version": 2,
    "name": "Titan AI Co-Pilot",
    "version": "7.6.0",
    "description": "Passive checkout assistant",
    "content_scripts": [
        {
            "matches": ["<all_urls>"],
            "js": ["copilot.js"],
            "run_at": "document_start",
            "all_frames": False,
        }
    ],
    "permissions": ["<all_urls>"],
}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PYTHON-SIDE ENGINE â€” Manages co-pilot configuration and deployment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class ThreeDSAIEngine:
    """
    AI Checkout Co-Pilot Engine.

    Manages the browser-side content script that silently assists
    the human operator during checkout. This Python class handles:
    - Generating the content script with target-specific configuration
    - Building the extension directory for Camoufox loading
    - Providing co-pilot status and configuration APIs
    """

    def __init__(self):
        self._extension_dir: Optional[Path] = None

    def get_copilot_script(self) -> str:
        """Get the full co-pilot content script for browser injection."""
        return COPILOT_CONTENT_SCRIPT

    def get_extension_manifest(self) -> Dict:
        """Get the web extension manifest."""
        return EXTENSION_MANIFEST.copy()

    def build_extension(self, output_dir: str = "/opt/titan/extensions/ai_copilot") -> Path:
        """
        Build the co-pilot as a loadable browser extension directory.
        This is called during browser launch to ensure the extension exists.

        Returns the path to the extension directory.
        """
        ext_dir = Path(output_dir)
        ext_dir.mkdir(parents=True, exist_ok=True)

        # Write manifest.json
        manifest_path = ext_dir / "manifest.json"
        with open(manifest_path, 'w') as f:
            json.dump(EXTENSION_MANIFEST, f, indent=2)

        # Write content script
        script_path = ext_dir / "copilot.js"
        with open(script_path, 'w') as f:
            f.write(COPILOT_CONTENT_SCRIPT)

        self._extension_dir = ext_dir
        logger.info(f"AI Co-Pilot extension built at {ext_dir}")
        return ext_dir

    def get_extension_path(self) -> Optional[Path]:
        """Get the path to the built extension, building if needed."""
        default = Path("/opt/titan/extensions/ai_copilot")
        if default.exists() and (default / "manifest.json").exists():
            return default
        return self.build_extension()

    def get_copilot_config(self, psp: str = "unknown",
                           card_country: str = "US",
                           amount: float = 100) -> Dict:
        """
        Get co-pilot configuration optimized for a specific target.

        This config can be passed to the content script via
        browser storage or extension messaging to fine-tune behavior.
        """
        config = {
            "psp": psp,
            "card_country": card_country,
            "amount": amount,
            "protections": {
                "iframe_shield": True,
                "network_monitor": True,
                "form_monitor": True,
                "operator_overlay": True,
            },
            "aggressiveness": "balanced",
        }

        # PSP-specific tuning
        psp_lower = psp.lower() if psp else "unknown"

        if psp_lower in ("authorize_net", "nmi", "payflow_pro", "square", "payeezy"):
            # These PSPs rarely trigger 3DS â€” minimal intervention needed
            config["aggressiveness"] = "minimal"
            config["notes"] = (
                f"{psp_lower} rarely triggers 3DS. Co-pilot in light monitoring mode. "
                f"Iframe shield active as precaution but unlikely to be needed."
            )

        elif psp_lower in ("stripe", "shopify_payments"):
            config["aggressiveness"] = "balanced"
            config["notes"] = (
                "Stripe/Shopify: risk-based 3DS. Iframe shield blocks 3DS Method "
                "fingerprinting. If 3DS still triggers, it's Radar-driven â€” "
                "co-pilot will alert you. Low amounts + US cards rarely trigger."
            )

        elif psp_lower in ("adyen",):
            if card_country in ("US", "CA", "AU", "JP", "BR", "MX"):
                config["aggressiveness"] = "balanced"
                config["notes"] = (
                    f"Adyen with {card_country} card: one-leg-out exempt from PSD2. "
                    f"3DS rate ~15%. Iframe shield active. Should be smooth."
                )
            else:
                config["aggressiveness"] = "aggressive"
                config["notes"] = (
                    f"Adyen with {card_country} card: PSD2 may apply. "
                    f"Iframe shield + network monitor at maximum. "
                    f"Keep amount under 30 EUR for low-value exemption."
                )

        elif psp_lower in ("worldpay",):
            config["aggressiveness"] = "aggressive"
            config["notes"] = (
                "WorldPay: mixed 3DS enforcement. If 3DS triggers, "
                "co-pilot will alert you. Timeout trick has ~25% success â€” "
                "if challenge appears, you can wait 5-15 min without entering OTP."
            )

        elif psp_lower in ("cybersource",):
            config["aggressiveness"] = "aggressive"
            config["notes"] = (
                "CyberSource: strict enforcement. High 3DS probability. "
                "Co-pilot will do its best but expect challenges on this PSP."
            )

        # Amount-based tuning
        if amount <= 30:
            config["amount_note"] = "Micro-transaction: PSD2 low-value exempt. Minimal 3DS risk."
        elif amount <= 100:
            config["amount_note"] = "Low amount: TRA exemption likely. Moderate 3DS risk."
        elif amount > 500:
            config["amount_note"] = "High amount: elevated 3DS probability. Consider splitting."

        return config

    def get_techniques_summary(self) -> List[Dict]:
        """
        Get a human-readable summary of what the co-pilot does.
        Useful for displaying in the Titan OS UI.
        """
        return [
            {
                "name": "3DS Method Iframe Shield",
                "what_it_does": (
                    "Blocks hidden 3DS fingerprinting iframes before they load. "
                    "The ACS never gets your device data, increasing the chance "
                    "of frictionless approval."
                ),
                "when_it_activates": "Automatically when you reach a checkout page",
                "timing": "<10ms (before the iframe can load)",
                "why_human_cant": (
                    "The iframe appears and loads in ~200ms. You can't even see it â€” "
                    "it's hidden (0x0 pixels). The co-pilot catches it via DOM mutation "
                    "observer in under 10ms."
                ),
                "detection_risk": "Very low â€” looks like a corporate firewall blocking iframes",
            },
            {
                "name": "Real-Time Network Signal Monitor",
                "what_it_does": (
                    "Watches every API response during checkout for 3DS signals, "
                    "decline codes, and approval confirmations. Alerts you instantly."
                ),
                "when_it_activates": "When checkout page is detected",
                "timing": "<5ms per response scanned",
                "why_human_cant": (
                    "30-80 network requests fire during a typical checkout in 2-5 seconds. "
                    "You'd need to have DevTools open and read every response body in real-time. "
                    "The co-pilot does this invisibly."
                ),
                "detection_risk": "None â€” passive monitoring only, no modification",
            },
            {
                "name": "Payment Form Context Awareness",
                "what_it_does": (
                    "Detects when you start entering card details and raises the "
                    "co-pilot to maximum alertness. All shields at full power."
                ),
                "when_it_activates": "When you click/focus on a card number input field",
                "timing": "Instant",
                "why_human_cant": "N/A â€” this is about coordinating the other protections",
                "detection_risk": "None â€” just listening for focus events",
            },
            {
                "name": "PSP Auto-Detection",
                "what_it_does": (
                    "Identifies which payment processor the merchant uses (Stripe, Adyen, "
                    "Braintree, etc.) and tunes protections accordingly."
                ),
                "when_it_activates": "When checkout page is detected",
                "timing": "<100ms",
                "why_human_cant": (
                    "You'd need to inspect page source, check loaded scripts, and identify "
                    "PSP-specific patterns. The co-pilot does this automatically."
                ),
                "detection_risk": "None â€” read-only DOM inspection",
            },
            {
                "name": "Operator Status Overlay",
                "what_it_does": (
                    "Shows a tiny shield icon in the corner so you always know the "
                    "co-pilot's status. Gray=sleeping, Blue=watching, Green=active, "
                    "Yellow=3DS detected, Red=decline."
                ),
                "when_it_activates": "Always visible (tiny, non-intrusive)",
                "timing": "Real-time",
                "why_human_cant": "N/A â€” this is the AI communicating WITH you",
                "detection_risk": "None â€” it's a local DOM overlay, not sent to any server",
            },
        ]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SINGLETON ACCESS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_engine: Optional[ThreeDSAIEngine] = None
_engine_lock = threading.Lock()


def get_3ds_ai_engine() -> ThreeDSAIEngine:
    """Get singleton ThreeDSAIEngine instance."""
    global _engine
    with _engine_lock:
        if _engine is None:
            _engine = ThreeDSAIEngine()
    return _engine


# Convenience functions
def get_ai_techniques(**kwargs) -> List[Dict]:
    return get_3ds_ai_engine().get_techniques_summary()

def get_optimal_exploit_stack(domain: str = "", psp: str = "unknown", **kwargs) -> Dict:
    return get_3ds_ai_engine().get_copilot_config(psp=psp, **kwargs)

def generate_exploit_script(psp: str = "stripe") -> str:
    return get_3ds_ai_engine().get_copilot_script()
